<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Legion Live</title>

  <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      max-width: 320px;
      font-size: 16px;
    }
    #videos video {
      width: 100%;
      max-width: 320px;
      margin-top: 10px;
      border: 2px solid #444;
      background: black;
    }
  </style>
</head>

<body>
  <h2>Legion Live</h2>

  <input id="username" placeholder="Username" />
  <input id="room" placeholder="Room name" />
  <button onclick="joinRoom()">Join Room</button>

  <div id="videos"></div>

  <script>
    const BACKEND_URL = "https://legion-live-backend-1.onrender.com";

    async function joinRoom() {
      try {
        const username = document.getElementById("username").value.trim();
        const roomName = document.getElementById("room").value.trim();

        if (!username || !roomName) {
          alert("Username and room required");
          return;
        }

        // 1. Fetch token
        const res = await fetch(
          `${BACKEND_URL}/livekit/token?room=${roomName}&username=${username}`
        );
        const { token } = await res.json();

        if (!token) {
          alert("Failed to get token");
          return;
        }

        // 2. Connect to LiveKit
        const room = new LivekitClient.Room();
        await room.connect(
          "wss://legion-live-qx4x35v2.livekit.cloud",
          token
        );

        // 3. Enable camera + mic
        // (this ALREADY publishes audio + video)
        await room.localParticipant.enableCameraAndMicrophone();

        // 4. Attach LOCAL video (correct LiveKit v2 way)
        room.localParticipant.videoTrackPublications.forEach(pub => {
          if (pub.track) {
            const el = pub.track.attach();
            el.autoplay = true;
            el.muted = true; // prevent feedback
            el.playsInline = true;
            document.getElementById("videos").appendChild(el);
          }
        });

        // 5. Attach REMOTE video
        room.on("trackSubscribed", track => {
          if (track.kind === "video") {
            const el = track.attach();
            el.autoplay = true;
            el.playsInline = true;
            document.getElementById("videos").appendChild(el);
          }
        });

      } catch (err) {
        console.error(err);
        alert("ERROR: " + err.message);
      }
    }
  </script>
</body>
</html>
