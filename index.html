<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Legion Live</title>

  <!-- LiveKit Client -->
  <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }

    input, button {
      padding: 12px;
      margin: 8px 0;
      width: 100%;
      max-width: 320px;
      font-size: 16px;
    }

    video {
      width: 100%;
      max-width: 320px;
      margin-top: 10px;
      border: 2px solid #444;
      background: black;
    }
  </style>
</head>
<body>

<h2>Legion Live</h2>

<input id="username" placeholder="Username" />
<input id="room" placeholder="Room name" />
<button id="joinBtn">Join Room</button>

<div id="videos"></div>

<script>
  const BACKEND_URL = "https://legion-live-backend-1.onrender.com";
  const LIVEKIT_URL = "wss://legion-live-qx4x35v2.livekit.cloud";

  const joinBtn = document.getElementById("joinBtn");
  const videosDiv = document.getElementById("videos");

  // ðŸ”§ ONLY THIS FUNCTION IS CHANGED
  joinBtn.onclick = async () => {
    try {
      alert("STEP 1: Click registered");

      const username = document.getElementById("username").value.trim();
      const roomName = document.getElementById("room").value.trim();

      if (!username || !roomName) {
        alert("Missing username or room");
        return;
      }

      alert("STEP 2: Fetching token");
      const res = await fetch(
        `${BACKEND_URL}/livekit/token?room=${roomName}&username=${username}`
      );
      const data = await res.json();

      if (!data.token) {
        alert("ERROR: Token missing");
        return;
      }

      alert("STEP 3: Token received");

      const room = new LivekitClient.Room();

      alert("STEP 4: Connecting to LiveKit");
      await room.connect(LIVEKIT_URL, data.token);

      alert("STEP 5: Connected");

      alert("STEP 6: Creating local tracks");
      const tracks = await LivekitClient.createLocalTracks({
        audio: true,
        video: true,
      });

      alert("STEP 7: Tracks created");

      for (const track of tracks) {
        await room.localParticipant.publishTrack(track);

        if (track.kind === "video") {
          const el = track.attach();
          el.muted = true;
          el.autoplay = true;
          el.playsInline = true;
          videosDiv.appendChild(el);
        }
      }

      alert("STEP 8: Video attached");

      room.on("trackSubscribed", (track) => {
        if (track.kind === "video") {
          const el = track.attach();
          el.autoplay = true;
          el.playsInline = true;
          videosDiv.appendChild(el);
        }
      });

    } catch (err) {
      alert("ERROR: " + (err && err.message ? err.message : err));
    }
  };
</script>

</body>
</html>
