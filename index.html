<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Legion Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>

<style>
:root{
  --bg:#0b0b0b;--panel:#151515;--accent:#c62828;
  --gold:#d4af37;--muted:#aaa;--text:#fff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Arial}
header{display:flex;justify-content:space-between;padding:14px;background:#000;border-bottom:1px solid #222}
header .coins{color:var(--gold);font-weight:bold}
.section{display:none;padding:14px}
.section.active{display:block}
.card{background:var(--panel);border:1px solid #222;border-radius:10px;padding:12px;margin-bottom:14px}
button{width:100%;padding:12px;margin-top:8px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-weight:bold}
input{width:100%;padding:12px;margin-bottom:8px;background:#000;border:1px solid #333;color:#fff;border-radius:8px}
#stage video{width:100%;border-radius:8px;margin-bottom:8px}
nav{position:fixed;bottom:0;left:0;right:0;display:flex;background:#000;border-top:1px solid #222}
nav div{flex:1;text-align:center;padding:10px;font-size:12px;color:var(--muted)}
nav div.active{color:#fff}
@keyframes floatUp{from{opacity:1;transform:translate(-50%,0)}to{opacity:0;transform:translate(-50%,-140px)}}
.gift-float{position:fixed;bottom:90px;left:50%;font-size:36px;animation:floatUp 2s ease-out forwards;z-index:999}
</style>
</head>

<body>

<header>
  <div>Legion Live</div>
  <div class="coins" id="coinDisplay">ðŸª™ 0</div>
</header>

<div id="auth" class="section active">
  <div class="card">
    <h3>Login / Register</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
  </div>
</div>

<div id="discover" class="section">
  <div class="card">
    <h3>ðŸ”¥ Featured Live</h3>
    <button id="watchBtn">Watch Legion Arena</button>
  </div>
</div>

<div id="live" class="section">
  <div class="card">
    <h3>Go Live</h3>
    <button id="goLiveBtn">Start Stream</button>
    <button id="giftBtn">Send Test Gift (100ðŸª™)</button>
  </div>
  <div id="stage"></div>
</div>

<div id="profile" class="section">
  <div class="card">
    <h3>Profile</h3>
    <p id="profileEmail"></p>
  </div>
</div>

<nav>
  <div data-tab="discover" class="active">Discover</div>
  <div data-tab="live">Live</div>
  <div data-tab="profile">Profile</div>
</nav>

<script>
const BACKEND="https://legion-live-backend-1.onrender.com";
const LIVEKIT_URL="wss://legion-live-qx4x35v2.livekit.cloud";
const ROOM="legion-arena";
let room;

/* NAV */
document.querySelectorAll("nav div").forEach(n=>{
  n.onclick=()=>tab(n.dataset.tab);
});
function tab(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('nav div').forEach(n=>n.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelector(`nav div[data-tab="${id}"]`).classList.add('active');
}

/* AUTH */
loginBtn.onclick=()=>auth("login");
registerBtn.onclick=()=>auth("register");
function auth(type){
  fetch(`${BACKEND}/api/auth/${type}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:email.value,password:password.value})
  }).then(r=>r.json()).then(d=>{
    if(!d.token)return alert("Auth failed");
    localStorage.token=d.token;
    auth.classList?.remove?.("active");
    tab("discover");
    coinDisplay.textContent=`ðŸª™ ${d.coins||0}`;
    profileEmail.textContent=email.value;
  });
}

/* CAMERA PERMISSION (ANDROID SAFE) */
goLiveBtn.addEventListener("click", async ()=>{
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:true});
    s.getTracks().forEach(t=>t.stop());
    startStream();
  }catch(e){
    alert("Camera/Mic blocked.\nTap ðŸ”’ â†’ Allow â†’ Reload");
  }
});

/* LIVEKIT */
async function startStream(){
  const r=await fetch(`${BACKEND}/api/stream/host-token?room=${ROOM}`);
  const d=await r.json();
  room=new LiveKit.Room();
  room.on(LiveKit.RoomEvent.TrackSubscribed,t=>stage.appendChild(t.attach()));
  await room.connect(LIVEKIT_URL,d.token);
  const cam=await LiveKit.createLocalVideoTrack({facingMode:"user"});
  const mic=await LiveKit.createLocalAudioTrack();
  await room.localParticipant.publishTrack(cam);
  await room.localParticipant.publishTrack(mic);
  const v=cam.attach();
  v.muted=true;v.playsInline=true;v.autoplay=true;
  stage.appendChild(v);
}

/* VIEWER */
watchBtn.onclick=async()=>{
  const r=await fetch(`${BACKEND}/api/stream/viewer-token?room=${ROOM}`);
  const d=await r.json();
  room=new LiveKit.Room();
  room.on(LiveKit.RoomEvent.TrackSubscribed,t=>stage.appendChild(t.attach()));
  tab("live");
  await room.connect(LIVEKIT_URL,d.token);
};

/* GIFTS */
giftBtn.onclick=async()=>{
  const r=await fetch(`${BACKEND}/api/gifts/send`,{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":localStorage.token},
    body:JSON.stringify({giftId:"rose",cost:100,room:ROOM})
  });
  const d=await r.json();
  if(!d.success)return alert("No coins");
  coinDisplay.textContent=`ðŸª™ ${d.balance}`;
  const g=document.createElement("div");
  g.className="gift-float";g.textContent="ðŸŽ";
  document.body.appendChild(g);
  setTimeout(()=>g.remove(),2000);
};
</script>

</body>
</html>
