<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Legion Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>

<style>
:root{
  --bg:#0b0b0b;--panel:#151515;--accent:#c62828;
  --muted:#aaa;--text:#fff
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Arial}
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px;background:#000;border-bottom:1px solid #222
}
header .coins{color:#ffd54f;font-weight:bold}
.section{display:none;padding:14px}
.section.active{display:block}
.card{
  background:var(--panel);border:1px solid #222;
  border-radius:10px;padding:12px;margin-bottom:14px
}
button{
  width:100%;padding:12px;margin-top:8px;
  background:var(--accent);border:none;border-radius:8px;
  color:#fff;font-weight:bold
}
#stage video{width:100%;border-radius:8px;margin-bottom:8px}
nav{
  position:fixed;bottom:0;left:0;right:0;
  background:#000;border-top:1px solid #222;
  display:flex
}
nav div{
  flex:1;text-align:center;padding:10px;color:var(--muted)
}
nav div.active{color:#fff}
input{
  width:100%;padding:12px;margin-bottom:8px;
  background:#000;border:1px solid #333;color:#fff;border-radius:8px
}
#giftModal{
  display:none;position:fixed;bottom:0;left:0;right:0;
  background:#111;border-top:2px solid #c62828;
  padding:12px;z-index:9999
}
#giftModal .grid{
  display:grid;grid-template-columns:repeat(4,1fr);gap:10px
}
#giftModal .grid div{
  background:#000;padding:10px;border-radius:8px;text-align:center
}
#giftOverlay{
  position:fixed;top:30%;left:50%;
  transform:translateX(-50%);
  font-size:40px;display:none;
  z-index:10000;color:white;
  text-shadow:0 0 10px black
}
</style>
</head>

<body>

<header>
  <div>Legion Live</div>
  <div class="coins" id="coinDisplay">游뿣 0</div>
</header>

<div class="section active" id="auth">
  <div class="card">
    <h3>Login / Register</h3>
    <input id="email" placeholder="Email">
    <input id="password" placeholder="Password" type="password">
    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>
  </div>
</div>

<div class="section" id="live">
  <div class="card">
    <button onclick="goLive()">Go Live</button>
    <button onclick="openGifts()">游꾸 Send Gift</button>
  </div>
  <div id="stage"></div>
</div>

<nav>
  <div class="active" onclick="show('live')">Live</div>
</nav>

<div id="giftModal">
  <div class="grid">
    <div onclick="sendGift('rose',10)">游꺛<br>10</div>
    <div onclick="sendGift('crown',100)">游녬<br>100</div>
    <div onclick="sendGift('lion',1000)">游부<br>1000</div>
    <div onclick="sendGift('dragon',5000)">游낼<br>5000</div>
  </div>
  <button onclick="closeGifts()">Close</button>
</div>

<div id="giftOverlay"></div>

<script>
const BACKEND="https://legion-live-backend-1.onrender.com";
const LIVEKIT_URL="wss://legion-live-qx4x35v2.livekit.cloud";
const ROOM="legion-arena";
let room=null, authToken=null;

function show(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function register(){
fetch(BACKEND+"/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({email:email.value,password:password.value})})
.then(r=>r.json()).then(afterAuth);
}

function login(){
fetch(BACKEND+"/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({email:email.value,password:password.value})})
.then(r=>r.json()).then(afterAuth);
}

function afterAuth(d){
if(!d.token){alert("Auth failed");return;}
authToken=d.token;
document.getElementById("coinDisplay").innerText=`游뿣 ${d.coins||0}`;
show('live');
}

async function goLive(){
const r=await fetch(`${BACKEND}/api/stream/host-token?room=${ROOM}`);
const d=await r.json();
room=new LiveKit.Room();

room.on(LiveKit.RoomEvent.TrackSubscribed,t=>{
const el=t.attach();el.playsInline=true;
document.getElementById("stage").appendChild(el);
});

room.on(LiveKit.RoomEvent.DataReceived,p=>{
const m=JSON.parse(new TextDecoder().decode(p));
if(m.type==="gift") showGift(m);
});

await room.connect(LIVEKIT_URL,d.token);

const cam=await LiveKit.createLocalVideoTrack();
const mic=await LiveKit.createLocalAudioTrack();

const v=cam.attach();v.muted=true;v.playsInline=true;
document.getElementById("stage").appendChild(v);

await room.localParticipant.publishTrack(cam);
await room.localParticipant.publishTrack(mic);
}

function openGifts(){giftModal.style.display="block"}
function closeGifts(){giftModal.style.display="none"}

async function sendGift(giftId,cost){
const r=await fetch(BACKEND+"/api/gifts/send",{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+authToken
},
body:JSON.stringify({giftId,cost,room:ROOM})
});
const d=await r.json();
if(!d.success){alert("Not enough coins");return;}
coinDisplay.innerText=`游뿣 ${parseInt(coinDisplay.innerText.replace(/\D/g,''))-cost}`;
room.localParticipant.publishData(
JSON.stringify({type:"gift",giftId,sender:d.sender}),
{reliable:true}
);
closeGifts();
}

function showGift({giftId,sender}){
const map={rose:"游꺛",crown:"游녬",lion:"游부",dragon:"游낼"};
giftOverlay.innerText=`${sender} sent ${map[giftId]}`;
giftOverlay.style.display="block";
setTimeout(()=>giftOverlay.style.display="none",2500);
}
</script>

</body>
</html>
