<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Legion Live</title>

  <!-- LiveKit Client -->
  <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }

    input, button {
      padding: 12px;
      margin: 8px 0;
      width: 100%;
      max-width: 320px;
      font-size: 16px;
    }

    video {
      width: 100%;
      max-width: 320px;
      margin-top: 10px;
      border: 2px solid #444;
      background: black;
    }
  </style>
</head>
<body>

<h2>Legion Live</h2>

<input id="username" placeholder="Username" />
<input id="room" placeholder="Room name" />
<button id="joinBtn">Join Room</button>

<div id="videos"></div>

<script>
  const BACKEND_URL = "https://legion-live-backend-1.onrender.com";
  const LIVEKIT_URL = "wss://legion-live-qx4x35v2.livekit.cloud";

  const joinBtn = document.getElementById("joinBtn");
  const videosDiv = document.getElementById("videos");

  joinBtn.onclick = async () => {
    try {
      const username = document.getElementById("username").value.trim();
      const roomName = document.getElementById("room").value.trim();

      if (!username || !roomName) {
        alert("Username and room required");
        return;
      }

      // 1️⃣ Fetch token
      const tokenRes = await fetch(
        `${BACKEND_URL}/livekit/token?room=${roomName}&username=${username}`
      );
      const tokenData = await tokenRes.json();

      if (!tokenData.token) {
        alert("Failed to get token");
        return;
      }

      // 2️⃣ Create room
      const room = new LiveKit.Room();

      await room.connect(LIVEKIT_URL, tokenData.token);

      // 3️⃣ Explicitly request camera + mic (ANDROID SAFE)
      const tracks = await LiveKit.createLocalTracks({
        audio: true,
        video: true,
      });

      for (const track of tracks) {
        await room.localParticipant.publishTrack(track);

        if (track.kind === "video") {
          const el = track.attach();
          el.muted = true;
          el.autoplay = true;
          el.playsInline = true;
          videosDiv.appendChild(el);
        }
      }

      // 4️⃣ Remote participants
      room.on("trackSubscribed", (track) => {
        if (track.kind === "video") {
          const el = track.attach();
          el.autoplay = true;
          el.playsInline = true;
          videosDiv.appendChild(el);
        }
      });

    } catch (err) {
      console.error(err);
      alert("Join failed. Check console.");
    }
  };
</script>

</body>
</html>
