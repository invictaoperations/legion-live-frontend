<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Legion Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>

<style>
:root{
  --bg:#0b0b0b;--panel:#151515;--accent:#c62828;
  --muted:#aaa;--text:#fff
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Arial}
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px;background:#000;border-bottom:1px solid #222
}
header .coins{color:#ffd54f;font-weight:bold}
#app{padding-bottom:70px}
.section{display:none;padding:14px}
.section.active{display:block}
.card{
  background:var(--panel);border:1px solid #222;
  border-radius:10px;padding:12px;margin-bottom:14px
}
.stream-grid{
  display:grid;grid-template-columns:repeat(2,1fr);gap:10px
}
.stream{
  background:#000;border-radius:8px;overflow:hidden;
  border:1px solid #222
}
.stream img{width:100%;height:120px;object-fit:cover}
.stream .info{padding:8px}
.stream .live{color:#ff5252;font-size:12px}
button{
  width:100%;padding:12px;margin-top:8px;
  background:var(--accent);border:none;border-radius:8px;
  color:#fff;font-weight:bold
}
nav{
  position:fixed;bottom:0;left:0;right:0;
  background:#000;border-top:1px solid #222;
  display:flex
}
nav div{
  flex:1;text-align:center;padding:10px;color:var(--muted);
  font-size:12px
}
nav div.active{color:#fff}
#stage video{width:100%;margin-bottom:8px;border-radius:8px}
input{
  width:100%;padding:12px;margin-bottom:8px;
  background:#000;border:1px solid #333;color:#fff;border-radius:8px
}
</style>
</head>

<body>

<header>
  <div>Legion Live</div>
  <div class="coins" id="coinDisplay">‚Äî</div>
</header>

<div id="app">

<!-- AUTH -->
<div id="auth" class="section active">
  <div class="card">
    <h3>Login / Register</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>
  </div>
</div>

<!-- DISCOVER -->
<div id="discover" class="section">
  <div class="card"><h3>üî• Featured</h3>
    <div class="stream-grid">
      <div class="stream" onclick="watchLive()">
        <img src="https://picsum.photos/400/300">
        <div class="info">
          <div class="live">LIVE</div>
          Legion Arena
        </div>
      </div>
    </div>
  </div>

  <div class="card"><h3>üé§ Voice Rooms</h3>
    <div class="stream-grid">
      <div class="stream"><img src="https://picsum.photos/401/300"></div>
      <div class="stream"><img src="https://picsum.photos/402/300"></div>
    </div>
  </div>

  <div class="card"><h3>üéÆ Gaming</h3>
    <div class="stream-grid">
      <div class="stream"><img src="https://picsum.photos/403/300"></div>
      <div class="stream"><img src="https://picsum.photos/404/300"></div>
    </div>
  </div>
</div>

<!-- LIVE -->
<div id="live" class="section">
  <div class="card">
    <h3>Go Live</h3>
    <button onclick="goLive()">Start Stream</button>
  </div>
  <div id="stage"></div>
</div>

<!-- PK -->
<div id="pk" class="section">
  <div class="card">
    <h3>‚öîÔ∏è Battles</h3>
    <p>PK battles coming online</p>
    <button disabled>Schedule PK</button>
  </div>
</div>

<!-- FOLLOWING -->
<div id="following" class="section">
  <div class="card"><h3>Following</h3>
    <p>No one live yet</p>
  </div>
</div>

<!-- PROFILE -->
<div id="profile" class="section">
  <div class="card">
    <h3>Profile</h3>
    <p id="profileEmail"></p>
    <button onclick="goLive()">Go Live</button>
  </div>
</div>

</div>

<nav>
  <div onclick="tab('discover')" class="active">Discover</div>
  <div onclick="tab('live')">Live</div>
  <div onclick="tab('pk')">PK</div>
  <div onclick="tab('following')">Following</div>
  <div onclick="tab('profile')">Profile</div>
</nav>

<script>
const BACKEND="https://legion-live-backend-1.onrender.com";
const LIVEKIT_URL="wss://legion-live-qx4x35v2.livekit.cloud";
const ROOM="legion-arena";
let room=null;

function tab(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('nav div').forEach(n=>n.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  [...document.querySelectorAll('nav div')].find(n=>n.textContent.toLowerCase().includes(id)).classList.add('active');
}

function register(){
fetch(BACKEND+"/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({email:email.value,password:password.value})})
.then(r=>r.json()).then(afterAuth);
}

function login(){
fetch(BACKEND+"/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({email:email.value,password:password.value})})
.then(r=>r.json()).then(afterAuth);
}

function afterAuth(d){
if(!d.token){alert("Auth failed");return;}
document.getElementById("auth").classList.remove("active");
tab('discover');
document.getElementById("coinDisplay").textContent=`ü™ô ${d.coins||0}`;
document.getElementById("profileEmail").textContent=email.value;
}

async function goLive(){
const r=await fetch(`${BACKEND}/stream/host-token?room=${ROOM}`);
const d=await r.json();
room=new LiveKit.Room();
room.on(LiveKit.RoomEvent.TrackSubscribed,t=>{
document.getElementById("stage").appendChild(t.attach());
});
await room.connect(LIVEKIT_URL,d.token);
const cam=await LiveKit.createLocalVideoTrack();
const mic=await LiveKit.createLocalAudioTrack();
await room.localParticipant.publishTrack(cam);
await room.localParticipant.publishTrack(mic);
document.getElementById("stage").appendChild(cam.attach());
}

async function watchLive(){
const r=await fetch(`${BACKEND}/stream/viewer-token?room=${ROOM}`);
const d=await r.json();
room=new LiveKit.Room();
room.on(LiveKit.RoomEvent.TrackSubscribed,t=>{
document.getElementById("stage").appendChild(t.attach());
});
tab('live');
await room.connect(LIVEKIT_URL,d.token);
}
</script>

</body>
</html>
